<?xml version="1.0" encoding="UTF-8" ?>
<!-- 
 * SqlMap-WsR001MigrationCmlPrint.xml
 *
 * WsR001MigCmlDaoのSqlMapファイルです。
 *
 * Copyright (c) 2014 DENSO CORPORATION. All rights reserved.
-->
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="WsR001MigrationCmlPrint">
    <!-- Domainの別名定義 -->
    <!-- Domain -->
    <typeAlias alias="MigCmlDomain"
        type="com.globaldenso.eca0027.core.business.domain.MigCmlDomain" />

    <!-- CriteriaDomain -->
    <typeAlias alias="MigCmlCriteriaDomain"
        type="com.globaldenso.eca0027.core.business.domain.criteria.MigCmlCriteriaDomain" />

    <!-- 検索結果をMapで受け取る -->
    <!-- ケースマークヘッダ連携 -->
    <resultMap id="MigCmlDomain_SearchMainMark" class="MigCmlDomain">
        <result property="mainMark" column="MAIN_MARK" />
    </resultMap>
    
    <!-- ケースマーク単位処理 -->
    <resultMap id="MigCmlDomain_SearchMarkHdrIf" class="MigCmlDomain">
        <result property="mainMark" column="MAIN_MARK" />
        <result property="palletNo" column="PALLET_NO" />
        <result property="shipperCd" column="SHIPPER_CD" />
        <result property="customerCd" column="CUSTOMER_CD" />
        <result property="lgcyShipTo" column="LGCY_SHIP_TO" />
        <result property="trnsCd" column="TRNS_CD" />
        <result property="plntCd" column="PLNT_CD" />
        <result property="lgcyWhCd" column="LGCY_WH_CD" />
        <result property="pkgFormTyp" column="PKG_FORM_TYP" />
        <result property="netWeight" column="NET_WEIGHT" />
        <result property="grossWeight" column="GROSS_WEIGHT" />
        <result property="volume" column="VOLUME" />
        <result property="containerGroupCd" column="CONTAINER_GRP_CD" />
        <result property="shipToCd" column="SHIP_TO_CD" />
        <result property="compCd" column="COMP_CD" />
        <result property="whCompCd" column="WHCOMP_CD" />
        <result property="whCd" column="WH_CD" />
        <result property="printerId" column="PRINTER_ID" /><!-- ST958 ADD -->
    </resultMap>
    
    <!-- ケースマーク明細連携 -->
    <resultMap id="MigCmlDomain_SearchMarkDtlIf" class="MigCmlDomain">
        <result property="pltzItemNo" column="PLTZ_ITEM_NO" />
        <result property="allocQty" column="ALLOC_QTY" />
        <result property="qtyUnit" column="QTY_UNIT" />
        <result property="itemWeight" column="ITEM_WEIGHT" />
        <result property="netWeight" column="NET_WEIGHT" /><!-- ST963 ADD -->
        <result property="shippingLot" column="SHIPPING_LOT" />
        <result property="plntCd" column="PLNT_CD" />
        <result property="currCd" column="CURR_CD" />
        <result property="invoiceKey" column="INVOICE_KEY" />
        <result property="stgInstrItemFlg" column="STG_INSTR_ITEM_FLG" />
        <result property="customTimingTyp" column="CUSTOM_TIMING_TYP" />
        <result property="containerSortingKey" column="CONTAINER_SORTING_KEY" />
        <result property="containerLooseTyp" column="CONTAINER_LOOSE_TYP" />
        <result property="loadingCd" column="LOADING_CD" />
        <result property="itemDescription" column="ITEM_DESCRIPTION" />
        <result property="expLimitTyp" column="EXP_LIMIT_TYP" />
        <result property="dngrItemFlg" column="DNGR_ITEM_FLG" />
        <result property="originCntryCd" column="ORIGIN_CNTRY_CD" />
        <result property="unitCd" column="UNIT_CD" />
    </resultMap>
    
    <!-- エラーレポート印刷 -->
    <!-- ST958 DEL
    ==<resultMap id="MigCmlDomain_SearchCmlPrintNm" class="MigCmlDomain">
    ==    <result property="printerNm" column="PRINTER_NM" />
    ==</resultMap>
    -->
    
    <!-- パレタイズ対象品受注情報登録 -->
    <resultMap id="MigCmlDomain_SearchMarkDtlIfByPltiz" class="MigCmlDomain">
        <result property="mainMark" column="MAIN_MARK" />
        <result property="pltzItemNo" column="PLTZ_ITEM_NO" />
        <result property="etdDueDt" column="ETD_DUE_DT" />
        <result property="customerPoNo" column="CUSTOMER_PO_NO" />
        <result property="customerItemNo" column="CUSTOMER_ITEM_NO" />
        <result property="customerItemNoOrg" column="CUSTOMER_ITEM_NO_ORG" />
        <result property="odrCtrlNo" column="ODR_CTRL_NO" />
        <result property="allocQty" column="ALLOC_QTY" />
        <result property="brch" column="BRCH" />
    </resultMap>



    <!-- =================================================================================================== -->
    <!-- ケースマークNo.一覧取り出し                                              -->
    <!-- =================================================================================================== -->
    
    <!-- 検索 SQL文 -->
    <select id="SearchByKeyMigCmlForHeadDistinct"  resultMap="MigCmlDomain_SearchMainMark">
            select
                distinct MAIN_MARK
            from 
                TW_CASE_MARK_HDR_IF
            order by
                MAIN_MARK
    </select>
    
    <!-- =================================================================================================== -->
    <!-- ケースマーク単位処理                                          -->
    <!-- =================================================================================================== -->
    
    <!-- 検索 SQL文 -->
    <select id="SearchByCondtionMigCmlForCmlHead"  resultMap="MigCmlDomain_SearchMarkHdrIf"
        parameterClass="MigCmlCriteriaDomain">
            select
                A.MAIN_MARK,
                A.PALLET_NO,
                A.SHIPPER_CD,
                A.CUSTOMER_CD,
                A.LGCY_SHIP_TO,
                A.TRNS_CD,
                A.PLNT_CD,
                A.LGCY_WH_CD,
                A.PKG_FORM_TYP,
                E.NET_WEIGHT, <!-- ST963 MOD -->
                A.GROSS_WEIGHT,
                A.VOLUME,
                A.CONTAINER_GRP_CD,
                A.PRINTER_ID, <!-- ST958 ADD -->
                B.SHIP_TO_CD,
                C.COMP_CD,
                D.COMP_CD WHCOMP_CD,
                D.WH_CD
            from
             TW_CASE_MARK_HDR_IF A ,
             TM_CIGMA_SHIP_TO_XREF B ,
             TM_CIGMA_CUSTOMER_XREF C ,
             TM_CIGMA_WH_XREF D ,
             <!-- ST963 ADD START -->
             (
                 select
                     MAIN_MARK
                     , SUM(ITEM_WEIGHT*ALLOC_QTY) NET_WEIGHT
                 from
                     TW_CASE_MARK_DTL_IF
                 group by
                     MAIN_MARK 
             ) E
             <!-- ST963 ADD END -->
            where
                A.MAIN_MARK = #mainMark#
            AND (
                    A.SHIPPER_CD = B.LGCY_LIB_COMP_CD(+)
                AND A.CUSTOMER_CD = B.CUSTOMER_CD(+)
                AND A.LGCY_SHIP_TO = B.LGCY_SHIP_TO(+)
                AND A.SHIPPER_CD = C.LGCY_LIB_COMP_CD(+)
                AND A.CUSTOMER_CD = C.CUSTOMER_CD(+)
                AND A.SHIPPER_CD = D.LGCY_LIB_COMP_CD(+)
                AND A.PLNT_CD = D.PLNT_CD(+)
                AND A.LGCY_WH_CD = D.LGCY_WH_CD(+)
                AND A.MAIN_MARK = E.MAIN_MARK(+) <!-- ST958 ADD -->
            )
    </select>
    
    <!-- =================================================================================================== -->
    <!-- ケースマーク明細連携                                             -->
    <!-- =================================================================================================== -->
    
    <!-- 検索 SQL文 -->
    <select id="SearchByCondtionMigCmlForCmlDtil"  resultMap="MigCmlDomain_SearchMarkDtlIf"
        parameterClass="MigCmlCriteriaDomain">
        select
          A.PLTZ_ITEM_NO
          , A.ALLOC_QTY
          , A.QTY_UNIT
          , A.ITEM_WEIGHT
          , A.NET_WEIGHT
          , A.SHIPPING_LOT
          , A.PLNT_CD
          , A.CURR_CD
          , B.INVOICE_KEY
          , B.STG_INSTR_ITEM_FLG
          , B.CUSTOM_TIMING_TYP
          , B.CONTAINER_SORTING_KEY
          , B.CONTAINER_LOOSE_TYP
          , B.LOADING_CD
          , B.ITEM_DESCRIPTION <!-- ST968 MOD -->
          , C.EXP_LIMIT_TYP
          , C.DNGR_ITEM_FLG
          , C.ORIGIN_CNTRY_CD
          , D.UNIT_CD 
        from
          ( 
            select
              PLTZ_ITEM_NO
              , SUM(ALLOC_QTY) ALLOC_QTY
              , MIN(QTY_UNIT) QTY_UNIT
              <!-- ST963 MOD START -->
              , MIN(ITEM_WEIGHT) ITEM_WEIGHT
              , MIN(ITEM_WEIGHT) * SUM(ALLOC_QTY) NET_WEIGHT
              <!-- ST963 MOD END -->
              , MIN(SHIPPING_LOT) SHIPPING_LOT
              , MIN(PLNT_CD) PLNT_CD
              , MIN(CURR_CD) CURR_CD 
            from
              TW_CASE_MARK_DTL_IF 
            where
              MAIN_MARK = #mainMark#
            group by
              PLTZ_ITEM_NO
          ) A
          , ( 
            select
              T.COMP_CD
              , T.ITEM_NO
              , T.PKG_CD
              , T.CUSTOMER_CD
              , T.LGCY_SHIP_TO
              , T.APLY_STRT_DT
              , T.INVOICE_KEY
              , T.STG_INSTR_ITEM_FLG
              , T.CUSTOM_TIMING_TYP
              , T.CONTAINER_SORTING_KEY
              , T.CONTAINER_LOOSE_TYP
              , T.LOADING_CD
              , T.ITEM_DESCRIPTION <!-- ST968 ADD -->
            from
              ( 
                select
                  COMP_CD
                  , ITEM_NO
                  , PKG_CD
                  , CUSTOMER_CD
                  , LGCY_SHIP_TO
                  , APLY_STRT_DT
                  , INVOICE_KEY
                  , STG_INSTR_ITEM_FLG
                  , CUSTOM_TIMING_TYP
                  , CONTAINER_SORTING_KEY
                  , CONTAINER_LOOSE_TYP
                  , LOADING_CD
                  , ITEM_DESCRIPTION <!-- ST968 ADD -->
                from
                  TM_EXP_ITEM_NO_SP_INFO 
                where
                  COMP_CD = #shipperCd#
                  and PKG_CD = ' ' 
                  and CUSTOMER_CD = #customerCd#
                  and LGCY_SHIP_TO = #lgcyShipTo#
                  and APLY_STRT_DT <![CDATA[<=]]> #aplyStrtDt#
              ) T
              , ( 
                select
                  ITEM_NO
                  , max(APLY_STRT_DT) APLY_STRT_DT 
                from
                  ( 
                    select
                      COMP_CD
                      , ITEM_NO
                      , PKG_CD
                      , CUSTOMER_CD
                      , LGCY_SHIP_TO
                      , APLY_STRT_DT 
                    from
                      TM_EXP_ITEM_NO_SP_INFO 
                    where
                      COMP_CD = #shipperCd#
                      and PKG_CD = ' ' 
                      and CUSTOMER_CD = #customerCd#
                      and LGCY_SHIP_TO = #lgcyShipTo#
                      and APLY_STRT_DT <![CDATA[<=]]> #aplyStrtDt#
                  )
                  group by ITEM_NO
              ) T2 
            where
              T.APLY_STRT_DT = T2.APLY_STRT_DT
              and T.ITEM_NO = T2.ITEM_NO
          ) B
          , ( 
            select
              T3.COMP_CD
              , T3.ITEM_NO
              , T3.APLY_STRT_DT
              , T3.ITEM_DESCRIPTION
              , T3.EXP_LIMIT_TYP
              , T3.DNGR_ITEM_FLG
              , T3.ORIGIN_CNTRY_CD 
            from
              ( 
                select
                  COMP_CD
                  , ITEM_NO
                  , APLY_STRT_DT
                  , ITEM_DESCRIPTION
                  , EXP_LIMIT_TYP
                  , DNGR_ITEM_FLG
                  , ORIGIN_CNTRY_CD 
                from
                  TM_EXP_FORMALITI_ITEM_NO 
                where
                  COMP_CD = #shipperCd#
                  and APLY_STRT_DT <![CDATA[<=]]> #aplyStrtDt#
              ) T3
              , ( 
                select
                  ITEM_NO
                  , max(APLY_STRT_DT) APLY_STRT_DT 
                from
                  ( 
                    select
                      COMP_CD
                      , ITEM_NO
                      , APLY_STRT_DT
                      , ITEM_DESCRIPTION
                      , EXP_LIMIT_TYP
                      , DNGR_ITEM_FLG
                      , ORIGIN_CNTRY_CD 
                    from
                      TM_EXP_FORMALITI_ITEM_NO 
                    where
                      COMP_CD = #shipperCd#
                      and APLY_STRT_DT <![CDATA[<=]]> #aplyStrtDt#
                  )
                group by ITEM_NO
              ) T4 
            where
              T3.APLY_STRT_DT = T4.APLY_STRT_DT
              and T3.ITEM_NO = T4.ITEM_NO
          ) C
          , TM_MEASURE_UNIT D 
        where
          A.PLTZ_ITEM_NO = B.ITEM_NO(+) 
          AND A.PLTZ_ITEM_NO = C.ITEM_NO(+) 
          AND A.QTY_UNIT = D.LGCY_UNIT_CD(+) <!-- ST969 MOD -->
        order by
          A.PLTZ_ITEM_NO
    </select>
    
    <!-- =================================================================================================== -->
    <!-- 出力先プリンタ情報検索                                                       -->
    <!-- =================================================================================================== -->
    
    <!-- 検索 SQL文 -->
    <!-- ST958 MOD change resultMap to resultClass=java.lang.String -->
    <select id="SearchByKeyMigCmlForPrinterInfo" resultClass="java.lang.String"
        parameterClass="MigCmlCriteriaDomain">
            select
                B.PRINTER_NM
            from 
                TM_PRINTER_PURPOSE A,
                TM_PRINTER B
            where
                A.COMP_CD = B.COMP_CD
            and
                A.PRINTER_ID = B.PRINTER_ID
            and
                A.COMP_CD = #compCd#
            and
                A.PLNT_CD = #plntCd#
            and 
                A.MIGRATION_PRINTER_FLG = 'Y'
    </select>
    
    <!-- =================================================================================================== -->
    <!-- パレタイズ対象品受注情報登録                                               -->
    <!-- =================================================================================================== -->
    
    <!-- 検索 SQL文 -->
    <select id="SearchByConditionMigCmlForCmlDtl"  resultMap="MigCmlDomain_SearchMarkDtlIfByPltiz"
        parameterClass="MigCmlCriteriaDomain">
            select
                A.MAIN_MARK
               ,A.PLTZ_ITEM_NO
               ,A.ETD_DUE_DT
               ,A.CUSTOMER_PO_NO
               ,A.CUSTOMER_ITEM_NO
               ,A.CUSTOMER_ITEM_NO_ORG
               ,A.ODR_CTRL_NO
               ,B.BRCH
               ,sum(A.ALLOC_QTY) ALLOC_QTY
            from
               TW_CASE_MARK_DTL_IF A,
               TT_PLTZ_ITEM B
            WHERE
               A.MAIN_MARK = B.MAIN_MARK
            and
               A.MAIN_MARK = #mainMark#
            and
               A.PLTZ_ITEM_NO = B.PLTZ_ITEM_NO
            group by
                A.MAIN_MARK
               ,A.PLTZ_ITEM_NO
               ,A.ETD_DUE_DT
               ,A.CUSTOMER_PO_NO
               ,A.CUSTOMER_ITEM_NO
               ,A.CUSTOMER_ITEM_NO_ORG
               ,A.ODR_CTRL_NO
               ,B.BRCH
    </select>
    
</sqlMap>